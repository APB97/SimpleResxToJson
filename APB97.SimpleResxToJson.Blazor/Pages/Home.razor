@page "/"
@using apb97.github.io.SimpleResxToJson.Shared

@implements IAsyncDisposable

@inject IJSRuntime JS

<PageTitle>Simple Resx to JSON</PageTitle>

<h2>Convert a *.resx file</h2>

<InputFile OnChange="OnFilesChanged" accept=".resx" />

@code {
    private IJSObjectReference? module;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/fileDownload.js");
    }

    private async Task OnFilesChanged(InputFileChangeEventArgs args)
    {
        await using var input = args.File.OpenReadStream(1024 * 1024);
        await using var inMemoryInput = await OpenInMemoryInputCopyAsync(input);
        await ConvertAsync(inMemoryInput, args.File.Name);
    }

    /// <summary>
    /// Workaround for synchrounous read not supported for BrowserFileStream.
    /// </summary>
    /// <param name="input"></param>
    /// <returns>In-memory stream with copy of <paramref name="input"/> stream contents.</returns>
    private async Task<MemoryStream> OpenInMemoryInputCopyAsync(Stream input)
    {
        var inMemoryInput = new MemoryStream((int)input.Length);
        await input.CopyToAsync(inMemoryInput);
        inMemoryInput.Seek(0, SeekOrigin.Begin);
        return inMemoryInput;
    }

    private async Task ConvertAsync(Stream input, string inputFileName)
    {
        if (module is null) return;

        var resultName = $"{Path.GetFileNameWithoutExtension(inputFileName)}.json";
        IResxConverter converter = new AllDataResxConverter(new ResxConverterOptions());

        await using var memoryStream = new MemoryStream();
        await converter.WriteAsJsonToStreamAsync(input, memoryStream);
        memoryStream.Seek(0, SeekOrigin.Begin);

        using var streamReference = new DotNetStreamReference(memoryStream);
        await module.InvokeVoidAsync("download", resultName, streamReference);
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (module is not null)
        {
            await module.DisposeAsync();
        }
    }
}